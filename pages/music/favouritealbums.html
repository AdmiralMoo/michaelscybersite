<head>
  <script src="/head-inject.js"></script>

  <title>The Changelog</title>
  <link rel="stylesheet" href="/assets/css/win98.css"/>
  <link rel="stylesheet" href="/assets/css/music.css"/>
</head>

<style>
  .universe-container {
    background-color: rgba(255,255,255,0);
    width: 100%;
    height: 100%;
  }

  /* set picker */
  #set-picker {
    display: flex;
    gap: 8px;
    justify-content: center;
    align-items: center;
    margin: 10px auto 6px;
    flex-wrap: wrap;
    max-width: 820px;
  }
  #set-picker button {
    cursor: pointer;
    padding: 6px 10px;
    border: 1px solid #bbb;
    background: #f3f3f3;
    font: 12px 'Franklin Gothic Medium','Arial Narrow',Arial,sans-serif;
  }
  #set-picker button.active { background:#dbeafe; border-color:#93c5fd; }

  #album-orbit {
    position: relative;
    width: 90vw;
    max-width: 800px;
    max-height: none;
    margin: auto;
    overflow: visible; 
  }

  #stars {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    display: block;
    pointer-events: none;
    z-index: 0;
  }

  #center-backdrop {
    position: absolute;
    top: 50%;
    left: 50%;
    background-position: center;
    background-size: unset; 
    background-repeat: no-repeat;
    transform: translate(-50%,-50%);
    opacity: 1;
    pointer-events: none;
    z-index: -1000;
    animation: spin 120s linear infinite;
  }
  @keyframes spin {
    from { transform: translate(-50%,-50%) rotate(0deg); }
    to   { transform: translate(-50%,-50%) rotate(360deg); }
  }

  #center-album {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%,-50%);
    border-radius: 10px;
    overflow: hidden;
    background-position: center;
    background-size: cover;
    transition: transform .4s cubic-bezier(.34,1.56,.64,1);
    display: block;
    z-index: 2;
  }
  .center-wrapper { width: 100%; height: 100%; position: relative; }

  #center-album:hover {
    transform: translate(-50%,-50%) scale(1.2);
    box-shadow: 0 0 15px 5px rgba(255,255,255,.75);
    z-index: 10;
  }

  #orbit-container { position: relative; z-index: 2; }

  .orbit-album {
    position: absolute;
    border-radius: 8px;
    transform: translate(-50%,-50%);
    background-position: center;
    background-size: cover;
    box-shadow: 0 0 15px 5px rgba(255,255,255,0);
    transition: transform .4s cubic-bezier(.34,1.56,.64,1), box-shadow .4s cubic-bezier(.34,1.56,.64,1);
  }
  .orbit-album:hover {
    transform: translate(-50%,-50%) scale(1.2);
    box-shadow: 0 0 15px 5px rgba(255,255,255,.75);
    z-index: 10;
  }

  /* tooltips */
  .orbit-album::after,
  .center-wrapper::after {
    content: attr(data-title) "\A" attr(data-artist);
    position: absolute;
    bottom: 110%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(211,211,211,.8);
    color: #000;
    font-size: 12px;
    padding: 4px 6px;
    border-radius: 4px;
    white-space: pre;
    opacity: 0;
    pointer-events: none;
    transition: opacity .2s ease;
    z-index: 9999;
    font-family: 'Franklin Gothic Medium','Arial Narrow',Arial,sans-serif;
    text-align: center;
  }
  .orbit-album:hover::after,
  .center-wrapper:hover::after { opacity: 1; }
</style>

<body>
  <main>
    <div id="set-picker"></div>

    <div class="maincontent-centred universe-container" style="min-height:60vh;">
      <div id="album-orbit">
        <canvas id="stars"></canvas>
        <div id="center-backdrop"></div>
        <div id="center-album"><div class="center-wrapper"></div></div>
        <div id="orbit-container"></div>
      </div>
    </div>
  </main>

  <script>
    fetch('./assets/json/favouritealbums.json')
      .then(r => r.json())
      .then(data => {
        const sets = Array.isArray(data?.sets) ? data.sets : (Array.isArray(data) ? data : []);
        const orbitEl  = document.getElementById('album-orbit');
        const starCv   = document.getElementById('stars');
        const starCtx  = starCv.getContext('2d');
        const backdrop = document.getElementById('center-backdrop');
        const centerEl = document.getElementById('center-album');
        const wrapEl   = centerEl.querySelector('.center-wrapper');
        const ringEl   = document.getElementById('orbit-container');
        const picker   = document.getElementById('set-picker');

        const cfg = {
          yBias: 0.50,
          centerRatio: 0.5,
          orbitRatio:  0.25,
          baseUnits:   3.0,
          stepUnits:   2.2,
          rScale:      0.8,
          speedBase:   0.0005,
          speedStep:   0.00025,
          ringCap:     6,
          ringAdd:     2,
          backdropFactor: 7.7,
          stars: {
            perRing: 128,
            base: 1.8,
            jitter: 1.6,
            strayUnits: 0.8,
            drift: 0.00045
          }
        };

        let cx, cy, centerSize, tileSize, rBase, rStep, backdropSize;
        let rings = [];
        let starRings = [];
        let t = 0;
        let tickStarted = false;

        function sizeCanvas() {
          const w = Math.max(1, Math.floor(orbitEl.clientWidth));
          const h = Math.max(1, Math.floor(orbitEl.clientHeight));
          if (starCv.width !== w || starCv.height !== h) {
            starCv.width = w;
            starCv.height = h;
          }
        }

        function calcSizes() {
        const w = orbitEl.offsetWidth;
        const h = orbitEl.offsetHeight;

        cx = w / 2;
        cy = h * cfg.yBias;

        const ref = w / 2;

        centerSize   = ref * cfg.centerRatio;
        tileSize     = ref * cfg.orbitRatio;

        rBase = cfg.rScale * cfg.baseUnits * tileSize;
        rStep = cfg.rScale * cfg.stepUnits * tileSize;

        backdropSize = centerSize * cfg.backdropFactor;
        }


        function setOrbitHeight() {
          const ringCount = rings.length || 1;
          const outer = rBase + (ringCount - 1) * rStep + tileSize * 0.5;
          const need = Math.max(outer * 2 + tileSize * 1.5, backdropSize + tileSize);
          orbitEl.style.height = Math.ceil(need) + 'px';
          cy = orbitEl.offsetHeight * cfg.yBias;
          sizeCanvas();
        }

        function weightedColor() {
          const x = Math.random();
          if (x < .70) return '#ffffff';
          if (x < .85) return '#ffeaa7';
          if (x < .95) return '#ff7675';
          return '#74b9ff';
        }

        function buildStars() {
          starRings.length = 0;
          for (let r = 0; r < rings.length; r++) {
            const R = rBase + r * rStep;
            const dir = (r % 2 === 0) ? 1 : -1;
            const list = [];
            for (let i = 0; i < cfg.stars.perRing; i++) {
              const a = Math.random() * Math.PI * 2;
              const ampUnits = cfg.stars.strayUnits * (0.4 + Math.random() * 0.8);
              const s = cfg.stars.base + Math.random() * cfg.stars.jitter;
              list.push({
                a,
                r: R,
                rHome: R,
                v: dir * (cfg.speedBase * 0.25 + r * cfg.speedStep * 0.2) * (0.7 + Math.random() * 0.6),
                ampUnits,
                amp: ampUnits * tileSize,
                phase: Math.random() * Math.PI * 2,
                drift: cfg.stars.drift * (0.6 + Math.random() * 0.8),
                color: weightedColor(),
                size: s
              });
            }
            starRings.push(list);
          }
        }

        function layoutBackdrop() {
          backdrop.style.width  = backdropSize + 'px';
          backdrop.style.height = backdropSize + 'px';
        }

        function clearRings() {
          rings.forEach(r => r.forEach(o => o.el.remove()));
          rings = [];
          starRings = [];
        }

        function layoutSet(set) {
          if (!set || !Array.isArray(set.albums) || set.albums.length === 0) return;

          clearRings();

          // baseline for height
          orbitEl.style.height = '120vh';
          sizeCanvas();
          calcSizes();

          // backdrop per set
          backdrop.style.backgroundImage = set.background ? `url("${set.background}")` : 'none';

          // center
          const first = set.albums[0];
          centerEl.style.backgroundImage = `url("${first.cover}")`;
          centerEl.style.width  = centerSize + 'px';
          centerEl.style.height = centerSize + 'px';
          wrapEl.dataset.title  = first.title || '';
          wrapEl.dataset.artist = first.artist || '';

          // rings
          let idx = 1;
          for (let r = 0; idx < set.albums.length; r++) {
            const cap   = cfg.ringCap + r * cfg.ringAdd;
            const slice = set.albums.slice(idx, idx + cap);
            const R     = rBase + r * rStep;
            const vBase = cfg.speedBase + r * cfg.speedStep;
            const dir   = (r % 2 === 0) ? 1 : -1;

            const objs = slice.map((album, i) => {
              const d = document.createElement('div');
              d.className = 'orbit-album';
              d.style.backgroundImage = `url("${album.cover}")`;
              d.style.width  = tileSize + 'px';
              d.style.height = tileSize + 'px';
              d.dataset.title  = album.title || '';
              d.dataset.artist = album.artist || '';
              ringEl.appendChild(d);

              const jitter = (tileSize * 0.3) * (Math.random() * 2 - 1);

              return {
                el: d,
                a: (i / slice.length) * Math.PI * 2,
                r: R + jitter,
                rHome: R,
                v: dir * vBase * (0.8 + Math.random() * 0.4)
              };
            });

            rings.push(objs);
            idx += cap;
          }

        setOrbitHeight();
        layoutBackdrop();
        buildStars();
        onResize();

        }

        function onResize() {
          calcSizes();

          centerEl.style.width  = centerSize + 'px';
          centerEl.style.height = centerSize + 'px';
          layoutBackdrop();

          document.querySelectorAll('.orbit-album').forEach(d => {
            d.style.width  = tileSize + 'px';
            d.style.height = tileSize + 'px';
          });

          rings.forEach((ring, i) => {
            const newHome = rBase + i * rStep;
            ring.forEach(o => {
              const off = o.r - o.rHome;
              o.rHome = newHome;
              o.r     = newHome + off;
            });
          });

          starRings.forEach((ring, i) => {
            const newHome = rBase + i * rStep;
            ring.forEach(s => {
              s.rHome = newHome;
              s.r = newHome;
              s.amp = s.ampUnits * tileSize;
            });
          });

          setOrbitHeight();
        }
        window.addEventListener('resize', onResize);

        function drawStars() {
          starCtx.clearRect(0,0,starCv.width,starCv.height);
          starCtx.imageSmoothingEnabled = false;
          starRings.forEach(ring => {
            ring.forEach(s => {
              s.a += s.v;
              const rr = s.r + Math.sin(t * s.drift + s.phase) * s.amp;
              const x = cx + rr * Math.cos(s.a);
              const y = cy + rr * Math.sin(s.a);
              const half = s.size / 2;
              starCtx.fillStyle = s.color;
              starCtx.fillRect(Math.round(x - half), Math.round(y - half), Math.ceil(s.size), Math.ceil(s.size));
            });
          });
        }

        function tick() {
          t += 1;
          rings.forEach(ring => {
            ring.forEach(o => { o.a += o.v; });

            const avoid = tileSize * 0.5;
            for (let i = 0; i < ring.length; i++) {
              for (let j = i + 1; j < ring.length; j++) {
                const a = ring[i], b = ring[j];
                const ax = a.r * Math.cos(a.a), ay = a.r * Math.sin(a.a);
                const bx = b.r * Math.cos(b.a), by = b.r * Math.sin(b.a);
                const dx = ax - bx, dy = ay - by;
                const d  = Math.hypot(dx, dy);
                if (d < avoid * 2 && d > 0) {
                  const k = (avoid * 2 - d) / (avoid * 2) * 0.01;
                  const ang = Math.atan2(dy, dx);
                  a.a += k * Math.cos(ang);
                  b.a -= k * Math.cos(ang);
                  a.r += k * 50 * Math.sin(ang);
                  b.r -= k * 50 * Math.sin(ang);
                }
              }
            }

            ring.forEach(o => {
              o.r += (o.rHome - o.r) * 0.02;
              const x = o.r * Math.cos(o.a);
              const y = o.r * Math.sin(o.a);
              o.el.style.left = (cx + x) + 'px';
              o.el.style.top  = (cy + y) + 'px';
            });
          });

          drawStars();
          requestAnimationFrame(tick);
        }

        function buildPicker() {
          picker.innerHTML = '';
          sets.forEach((s, i) => {
            const b = document.createElement('button');
            b.textContent = s.label || `Set ${i+1}`;
            b.dataset.key = s.label || String(i);
            b.addEventListener('click', () => {
              document.querySelectorAll('#set-picker button').forEach(x => x.classList.remove('active'));
              b.classList.add('active');
              const key = b.dataset.key;
              const byLabel = sets.find(x => (x.label||'') === key);
              const set = byLabel || sets[parseInt(key,10)] || sets[i];
              layoutSet(set);
            });
            picker.appendChild(b);
          });
          // mark first active
          const firstBtn = picker.querySelector('button');
          if (firstBtn) firstBtn.classList.add('active');
        }

        // init
        orbitEl.style.height = '120vh';
        sizeCanvas();
        buildPicker();
        layoutSet(sets[0] || null);

        if (!tickStarted) { tickStarted = true; tick(); }
      });
  </script>
</body>
